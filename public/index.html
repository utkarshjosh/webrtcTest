<!DOCTYPE html>
<html lang="en">
    <head>

        <link rel="stylesheet" href="styles.css">

        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>My Video App</title>
    </head>
    <body>

        <div>
                <h3>Your Id: <span id="myId"></span></h3>
                <h3>Your name: <span id="myname"></span></h3>

                <h2>Online Users (click to connect)</h2>
                <div id="users">

                </div>
                <video id="local-video"></video>
                <video id="remote-video"></video>
            </div>
            </div>
            <p id="status"></p>
        </div>

        <!-- Import socket.io script -->
        <script src="/socket.io/socket.io.js"></script>

        <script>
               const peer = new RTCPeerConnection({
    iceServers: [
        {
            urls: "stun:stun.stunprotocol.org"
        }
    ]
});
console.log("----created peeres", {peer})


            const getUserMedia = async () => {
                console.log("------getusermedia trigger -- nav: ",window.navigator)
     const userMedia = await window.navigator.mediaDevices.getUserMedia({
            video: true,
     });

      const videoEle = document.getElementById('local-video');
      videoEle.srcObject = userMedia;
      videoEle.play()
 }

            let MY_ID=""
            const socket = io();
            socket.on("connect",()=>{
                console.log("connected")
                const name = prompt("enter your name")
                if(!name) {return alert("You need to enter your name !!!" )}
                socket.emit("i:joined", {name})
                const nameEle = document.getElementById("myname")
                nameEle.innerHTML= name
                
            })
            const getAndUpdateUsers = async () => {
                const usersDiv = document.getElementById('users');

                const response = await fetch('/users', { method: 'GET' });
                const jsonResponse = await response.json();

                console.log(jsonResponse)

                jsonResponse.forEach(user => {
                    const btn = document.createElement('button');
                    const textNode = document.createTextNode("api: "+user[1].name);

                    btn.setAttribute('onclick', `createCall({name:'${user[1].name}',to: '${user[1].id}'})`);
                    btn.appendChild(textNode);
                    usersDiv.appendChild(btn);
                });
            }

            socket.on('user:joined', ({name,id}) => {
                const usersDiv = document.getElementById('users');
                const btn = document.createElement('button');
                const textNode = document.createTextNode("sk: "+ name);
                
                btn.appendChild(textNode);
                btn.setAttribute('onclick', `createCall({name:'${name}',to: '${id}'})`);
                usersDiv.appendChild(btn);
            })

            socket.on("ugotconnected", (id)=>{
                MY_ID = id
                const myidEle = document.getElementById("myId")
                myidEle.innerHTML = id
            })
            window.addEventListener('load', getAndUpdateUsers);
            window.addEventListener('load', getUserMedia);

         
const createCall = async ({name, to}) => {
    console.log("calling createCall", {name, to})
         const status = document.getElementById('status');
         status.innerText = `Calling ${name} ${to}`;

         const localOffer = await peer.createOffer();
         console.log({localOffer})
         await peer.setLocalDescription(new RTCSessionDescription(localOffer));

         socket.emit('outgoing:call', { fromOffer: localOffer, to })
}

socket.on('incomming:call', async data => {
                const status = document.getElementById('status');
                status.innerText = 'incomming:call';

                const { from, offer } = data;
                    console.log("incomming offer ", {data})
                await peer.setRemoteDescription(new RTCSessionDescription(offer));

                const answerOffer = await peer.createAnswer();
                console.log("replying answer ", {answerOffer})
                await peer.setLocalDescription(new RTCSessionDescription(answerOffer));

                socket.emit('call:accepted', { answer: answerOffer, to: from });
                const mySteam = await window.navigator.mediaDevices.getUserMedia({
                    video: true,
                });

                for (const track of mySteam.getTracks()) {
                    peer.addTrack(track, mySteam);
                }
            })
peer.ontrack = async ({streams: [stream]}) => {
        console.log("got a track!!")
       const status = document.getElementById('status');
       status.innerText = 'Incomming Stream';

        console.log(stream)

         const video = document.getElementById('remote-video');
         video.srcObject = stream;
         video.play();

         const mySteam = await window.navigator.mediaDevices.getUserMedia({
                  video: true,
         });

         for (const track of mySteam.getTracks()) {
                 peer.addTrack(track, mySteam);
         }

 }

socket.on('incomming:answer', async data => {
       const { offer } = data;
    const settingPeer=    await peer.setRemoteDescription(new RTCSessionDescription(offer), (s)=>{
        console.log("sucess!!", {s})

    }, (e)=>{
        console.log("error ", {e})
    });
    console.log("setting new perr ", {settingPeer} )
});


        </script>
    </body>
</html>
